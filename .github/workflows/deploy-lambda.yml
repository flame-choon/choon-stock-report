name: Deploy Lambda Functions

on:
  push:
    branches:
      - main
    paths:
      - 'Lambda/**'
  workflow_dispatch:
    inputs:
      lambda_folder:
        description: '배포할 Lambda 폴더명 (예: add-stock-tickers)'
        required: false
        type: string

env:
  AWS_REGION: ap-northeast-2

jobs:
  detect-changes:
    name: Detect Changed Lambda Functions
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed Lambda folders
        id: set-matrix
        run: |
          # 수동 실행 시 특정 폴더 지정
          if [ -n "${{ github.event.inputs.lambda_folder }}" ]; then
            FOLDERS='["${{ github.event.inputs.lambda_folder }}"]'
            echo "matrix={\"folder\":$FOLDERS}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Manual deployment for: ${{ github.event.inputs.lambda_folder }}"
            exit 0
          fi

          # 변경된 Lambda 폴더 감지
          CHANGED_FOLDERS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | \
            grep '^Lambda/' | \
            cut -d'/' -f2 | \
            sort -u | \
            jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "Changed folders: $CHANGED_FOLDERS"

          if [ "$CHANGED_FOLDERS" == "[]" ] || [ -z "$CHANGED_FOLDERS" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"folder\":[]}" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "matrix={\"folder\":$CHANGED_FOLDERS}" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy ${{ matrix.folder }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Get Lambda function name
        id: lambda-name
        run: |
          # 폴더명을 Lambda 함수명으로 매핑
          FOLDER="${{ matrix.folder }}"
          case "$FOLDER" in
            "add-stock-tickers")
              LAMBDA_NAME="choon-add-stock-tickers"
              ;;
            "get-stock-tickers")
              LAMBDA_NAME="choon-prd-apne2-get-stock-tickers"
              ;;
            *)
              # 기본: 폴더명 그대로 사용
              LAMBDA_NAME="choon-prd-apne2-$FOLDER"
              ;;
          esac
          echo "lambda_name=$LAMBDA_NAME" >> $GITHUB_OUTPUT
          echo "Lambda function name: $LAMBDA_NAME"

      - name: Install dependencies
        run: |
          cd Lambda/${{ matrix.folder }}
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt -t ./package
          fi

      - name: Create deployment package
        run: |
          cd Lambda/${{ matrix.folder }}

          # 패키지 디렉토리가 있으면 포함
          if [ -d package ]; then
            cd package
            zip -r ../deployment.zip .
            cd ..
            zip -g deployment.zip lambda_function.py
          else
            zip deployment.zip lambda_function.py
          fi

          # 추가 Python 파일이 있으면 포함
          find . -maxdepth 1 -name "*.py" ! -name "lambda_function.py" -exec zip -g deployment.zip {} \;

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ steps.lambda-name.outputs.lambda_name }} \
            --zip-file fileb://Lambda/${{ matrix.folder }}/deployment.zip

      - name: Wait for update to complete
        run: |
          aws lambda wait function-updated \
            --function-name ${{ steps.lambda-name.outputs.lambda_name }}

      - name: Deployment summary
        run: |
          echo "✅ Successfully deployed ${{ matrix.folder }} to ${{ steps.lambda-name.outputs.lambda_name }}"
